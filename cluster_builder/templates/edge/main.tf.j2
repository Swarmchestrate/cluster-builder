locals {
  cluster_name   = "{{ cluster_name }}"  
  edge_device_ip = "{{ edge_device_ip }}" 
  k3s_token      = "{{ k3s_token }}" 
  master_ip      = "{{ master_ip }}"
  k3s_role       = "{{ k3s_role }}"
}

resource "null_resource" "deploy_k3s_edge" {

  connection {
    type        = "ssh"
    user        = "{{ ssh_user }}"
    password    = "{{ ssh_password }}"
    host        = local.edge_device_ip
  }

  provisioner "file" {
    source      = "${local.k3s_role}_user_data.sh"
    destination = "/tmp/edge_user_data.sh"
  }

  provisioner "remote-exec" {
    inline = [
      "chmod +x /tmp/edge_user_data.sh",
      "sudo K3S_TOKEN='${local.k3s_token}' MASTER_IP='${local.master_ip}' /tmp/edge_user_data.sh"
    ]
  }

  tags = [local.cluster_name]
}
